# Урок 3. Serial (UART): теория и практика в Arduino

В этом уроке разбираем **последовательный интерфейс**: как он устроен, чем отличается `Serial Monitor` от `Serial Plotter`, как **печать** и **парсинг** строк помогают отлаживать и управлять устройствами.

![Serial Monitor](assets/serial-monitor.png)
![Serial Plotter](assets/serial-plotter.png)

---

## Краткая теория: что такое Serial (UART)
- **UART** — асинхронный последовательный протокол «от устройства к устройству». На Arduino `Serial` подключён к USB‑UART мосту.
- Формат кадра по умолчанию: **8N1** (8 бит данных, нет чётности, 1 стоп‑бит). Скорость (baud): обычно **9600**, **115200**.
- Данные передаются байтами. На ПК вы видите их в `Serial Monitor` как символы (ASCII).
- **Важно:** скорость в `Serial.begin(…);` **должна совпадать** со скоростью в окне монитора, иначе будут «кракозябры».
- Открытие `Serial Monitor` вызывает **перезагрузку** платы. Это нормально.


### Буфер и «блокирующие» вызовы
- PC и Arduino обмениваются через **буферы** (специальные микросхемы, данные сначала попадают в них, и только потом читаем их из программы). Чтение без данных блокирует только в некоторых методах.
- `Serial.available()` возвращает, сколько байт в буфере входа — используйте его перед чтением.
- `Serial.read()` — забрать 1 байт (или `-1`, если пусто). Низкоуровневый метод.
- `Serial.readString()`, `readStringUntil('\n')`, `parseInt()` — удобные, но могут **ждать** данные до `Serial.setTimeout(ms)` (по умолчанию 1000 мс).

### Печать и форматирование
- `Serial.print(x)` — печатает без перевода строки, `Serial.println(x)` — с переводом.
- Можно печатать **по частям**: `Serial.print("LED="); Serial.println(v);`
- Числа можно печатать в разных системах счисления: `Serial.println(n, HEX)`.

### Линии завершения и парсинг
- В `Serial Monitor` выберите `Both NL & CR` или хотя бы `Newline` — чтобы команды приходили `\n`‑заканчиваемыми строками.
- Для команд удобно читать **строку** до `\n`: `Serial.readStringUntil('\n')`, затем `trim()`, `split` и парсить.
- `parseInt()` быстро вытаскивает число из потока, но помните про тайм‑аут и «проглатывание» лишних символов.

### Почему Serial полезен
- Лог событий (нажатия, таймеры, режимы) — **моментально видно**, что происходит.
- **Командный интерфейс** — можно управлять устройством без перешивки: `STATUS`, `SET 3 1`, `TOGGLE 4` и т.п.
- **Serial Plotter** — быстрый график для аналоговых сигналов (потенциометр, датчики).

---

## Скетчи урока

### V1 — Логируем события: запуск и нажатия
Файл: [`sketches/01_serial_events/01_serial_events.ino`](sketches/01_serial_events/01_serial_events.ino)

Что делает:
- В `setup()` выводит `START`.
- В `loop()` печатает `Button pressed` / `Button released` при смене состояния кнопки (D5, `INPUT_PULLUP`).
- Светодиод D2 изменяет свое состояние при нажатии .

Скриншот: `assets/serial-monitor.png` (пример логов).

---

### V2 — Читаем число и переключаем светодиод; кнопка управляет тем же
Файл: [`sketches/02_serial_pin_toggle/02_serial_pin_toggle.ino`](sketches/02_serial_pin_toggle/02_serial_pin_toggle.ino)

Что делает:
- Вводите **номер пина** (2..13) и отправляете Enter — этот пин переключится (toggle).
- «Текущая цель» `TARGET` меняется на введённый пин.
- Нажатие **кнопки (D5)** также переключает **тот же** выбранный пин.
- Все события печатаются в монитор порта.


---

### V3 — Два числа через пробел: `<pin> <state>`
Файл: [`sketches/03_serial_set_pin_state/03_serial_set_pin_state.ino`](sketches/03_serial_set_pin_state/03_serial_set_pin_state.ino)

Что делает:
- Читаем строку до `\n`, парсим как **номер пина** и **значение** `0` или `1`.

- Если формат неверный или значение не `0/1` — печатаем `ERR FORMAT` / `ERR VAL`.

- На успех: `SET <pin> = <state>`.



Пример команд: `3 1` (включить D3), `4 0` (выключить D4).

---

### V4 — Форматированные строки и команда `STATUS`
Файл: [`sketches/04_serial_status_formatting/04_serial_status_formatting.ino`](sketches/04_serial_status_formatting/04_serial_status_formatting.ino)

Что делает:

- По команде `STATUS` печатает состояние светодиодов D2/D3/D4 в одной строке.

- Используется `snprintf` для форматирования (альтернатива: печатать частями или соединении `String`).

Пример вывода: `LED 2=0, 3=1, 4=0`.

Скриншот: `assets/serial-status.png`.

---

### V5 — Аналоговый порт и Serial Plotter

Файл: [`sketches/05_analog_plotter/05_analog_plotter.ino`](sketches/05_analog_plotter/05_analog_plotter.ino)

Что делает:

- Читает `A0` (потенциометр), печатает число `0..1023`.

- Откройте **Tools → Serial Plotter** — увидите график.



Теория:

- Потенциометр — **делитель напряжения**: средняя ножка ─ A0, крайние ─ +5V и GND.

- `analogRead(A0)` возвращает 0..1023 (10 бит). Напряжение ≈ `raw * 5.0 / 1023.0` В.



Скриншот: `assets/serial-plotter.png`.

---

## Частые ошибки и решения
- «Кракозябры» в мониторе — **скорость** не совпадает (`Serial.begin` и в настройке окна).

- Команда «не доезжает» — проверьте, что `Serial Monitor` отправляет `\n` (Line ending: `Newline` или `Both NL & CR`).

- `parseInt()` «висит» — уменьшите тайм‑аут: `Serial.setTimeout(100)` и проверяйте `Serial.available()`.

- На UNO **нет** `Serial.printf` — используйте `snprintf` в буфер `char[]` или печатайте частями.


